<!doctype html>

<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Scanner MRZ - Passeport (démo)</title>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:12px}
    video,canvas{max-width:100%;border:1px solid #ccc;border-radius:6px}
    .controls{margin-top:8px;display:flex;gap:8px;flex-wrap:wrap}
    pre{background:#111;color:#0f0;padding:8px;border-radius:6px;overflow:auto}
    .result{margin-top:8px}
    .warn{color:#a00}
    .error{color:#a00;white-space:pre-wrap}
  </style>
</head>
<body>
  <h1>Scanner MRZ - Passeport (démo)</h1>
  <p>Ouvre ce fichier via <strong>https://</strong> ou <strong>http://localhost</strong> (obligatoire pour la caméra). Autorise l'accès caméra. Tu peux aussi tester en important une image.</p>
  <div id="err" class="error"></div><video id="video" playsinline autoplay></video> <canvas id="canvas" style="display:none"></canvas>

  <div class="controls">
    <button id="startBtn">Démarrer caméra</button>
    <button id="snapBtn">Prendre photo & extraire MRZ</button>
    <button id="uploadBtn">Choisir image</button>
    <input id="fileInput" type="file" accept="image/*" style="display:none">
  </div>  <div class="result">
    <h3>OCR brut (quelques dernières lignes)</h3>
    <pre id="ocrOut">—</pre><h3>MRZ détectée (nettoyée)</h3>
<pre id="mrzOut">—</pre>

<h3>Données parsées</h3>
<pre id="dataOut">—</pre>

<div class="warn">Respecte la vie privée / RGPD avant d'utiliser en production.</div>

  </div>  <!-- Tesseract.js + chemins explicites pour éviter les erreurs de chargement des workers/langues -->  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.1.1/dist/tesseract.min.js"></script>  <h1>Scanner MRZ - Passeport (démo)</h1>
  <p>Ce fichier est une démo locale : ouvre-le sur un serveur (ou via Live Server) et autorise la caméra. N'utilise pas pour collecter des données sans consentement.</p><video id="video" playsinline autoplay></video> <canvas id="canvas" style="display:none"></canvas>

  <div class="controls">
    <button id="startBtn">Démarrer caméra</button>
    <button id="snapBtn">Prendre photo & extraire MRZ</button>
    <button id="uploadBtn">Choisir image</button>
    <input id="fileInput" type="file" accept="image/*" style="display:none">
  </div>  <div class="result">
    <h3>OCR brut (quelques dernières lignes)</h3>
    <pre id="ocrOut">—</pre><h3>MRZ détectée (nettoyée)</h3>
<pre id="mrzOut">—</pre>

<h3>Données parsées</h3>
<pre id="dataOut">—</pre>

<div class="warn">Attention : respectez la vie privée et la législation locale avant d'utiliser ce script en production.</div>

  </div>  <!-- Tesseract.js CDN -->  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.1.1/dist/tesseract.min.js"></script>  <script>
  const video = document.getElementById('video');
  const canvas = document.getElementById('canvas');
  const startBtn = document.getElementById('startBtn');
  const snapBtn = document.getElementById('snapBtn');
  const fileInput = document.getElementById('fileInput');
  const uploadBtn = document.getElementById('uploadBtn');
  const ocrOut = document.getElementById('ocrOut');
  const mrzOut = document.getElementById('mrzOut');
  const dataOut = document.getElementById('dataOut');
  const err = document.getElementById('err');

  let stream;

  function showError(e){
    console.error(e);
    err.textContent = (e && e.message) ? e.message : String(e);
  }

  // Avertir si contexte non sécurisé (caméra refusée)
  if (!window.isSecureContext && location.hostname !== 'localhost') {
    showError('Contexte non sécurisé: ouvre ce fichier via https:// ou http://localhost (pas file://).');
  }

  startBtn.onclick = async () => {
    try{
      if(!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){
        throw new Error('getUserMedia non disponible dans ce navigateur.');
      }
      stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}});
      video.srcObject = stream;
      await video.play();
    }catch(e){ showError(e); }
  }

  uploadBtn.onclick = ()=> fileInput.click();
  fileInput.onchange = ()=>{
    const f = fileInput.files[0];
    if(!f) return;
    const url = URL.createObjectURL(f);
    loadImageFromURL(url);
  }

  snapBtn.onclick = async ()=>{
    try{
      if(!video.videoWidth){
        throw new Error('Démarre d’abord la caméra ou importe une image.');
      }
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(video,0,0);
      const tmp = cropForMrz(canvas);
      await runOCR(tmp);
    }catch(e){ showError(e); }
  }

  function cropForMrz(sourceCanvas){
    // Recadrage heuristique: bas de l'image
    const cropH = Math.floor(sourceCanvas.height * 0.25);
    const cropW = Math.floor(sourceCanvas.width * 0.95);
    const sx = Math.floor((sourceCanvas.width - cropW)/2);
    const sy = sourceCanvas.height - cropH - Math.floor(sourceCanvas.height*0.02);
    const tmp = document.createElement('canvas');
    tmp.width = cropW; tmp.height = cropH;
    tmp.getContext('2d').drawImage(sourceCanvas, sx, sy, cropW, cropH, 0,0, cropW, cropH);
    return tmp;
  }

  async function loadImageFromURL(url){
    try{
      const img = new Image();
      img.crossOrigin = 'anonymous';
      img.onload = async ()=>{
        canvas.width = img.naturalWidth;
        canvas.height = img.naturalHeight;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img,0,0);
        const tmp = cropForMrz(canvas);
        await runOCR(tmp);
      }
      img.onerror = ()=>showError('Impossible de charger l’image');
      img.src = url;
    }catch(e){ showError(e); }
  }

  async function runOCR(canvasEl){
    ocrOut.textContent = 'Traitement OCR...';
    mrzOut.textContent = '...';
    dataOut.textContent = '...';

    try{
      const blob = await new Promise(res=>canvasEl.toBlob(res,'image/jpeg',0.92));

      const worker = Tesseract.createWorker({
        logger: m=>console.log(m),
        workerPath: 'https://cdn.jsdelivr.net/npm/tesseract.js@4.1.1/dist/worker.min.js',
        corePath: 'https://cdn.jsdelivr.net/npm/tesseract.js-core@4.0.2/tesseract-core.wasm.js',
        langPath: 'https://tessdata.projectnaptha.com/4.0.0_best'
      });

      await worker.load();
      await worker.loadLanguage('eng');
      await worker.initialize('eng');
      await worker.setParameters({tessedit_char_whitelist: 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789<'});

      const { data } = await worker.recognize(blob);
      await worker.terminate();

      const lines = data.text.split(/
?
/).map(l=>l.trim()).filter(Boolean);
      ocrOut.textContent = lines.slice(-10).join('
') || '(aucune ligne)';

      const mrzLines = findMrzLines(lines.join('
'));
      if(!mrzLines){
        mrzOut.textContent = 'Aucune MRZ fiable trouvée. (Approche, éclaire et garde horizontal)';
        dataOut.textContent = '-';
        return;
      }
      mrzOut.textContent = mrzLines.join('
');
      const parsed = parsePassportMrz(mrzLines);
      dataOut.textContent = JSON.stringify(parsed,null,2);
    }catch(e){ showError(e); }
  }

  function findMrzLines(text){
    const cleaned = text.toUpperCase().replace(/[^A-Z0-9<>

]/g,'');
    const candidateLines = cleaned.split(/
?
/).map(l=>l.trim()).filter(Boolean);

    const len44 = candidateLines.filter(l=>l.length>=40 && l.length<=44);
    if(len44.length>=2){
      const lastTwo = len44.slice(-2).map(l=>padMrzLine(l));
      return lastTwo;
    }
    const len30 = candidateLines.filter(l=>l.length>=26 && l.length<=30);
    if(len30.length>=3){
      const lastThree = len30.slice(-3).map(l=>padMrzLine(l,30));
      return lastThree;
    }
    return null;
  }

  function padMrzLine(line, expected=44){
    if(line.length===expected) return line;
    if(line.length>expected) return line.slice(0,expected);
    return line + '<'.repeat(expected-line.length);
  }

  function parsePassportMrz(lines){
    if(!lines || lines.length<2) return {error:'MRZ non fournie'};
    const l1 = lines[0];
    const l2 = lines[1];
    if(l1.length!==44 || l2.length!==44) return {error:'Format MRZ inattendu'};

    const docType = l1.slice(0,1);
    const issuing = l1.slice(2,5);
    const namesRaw = l1.slice(5).replace(/<+$/,'');
    const [surname, given] = namesRaw.split('<<');

    const passportNumber = l2.slice(0,9).replace(/<+$/,'');
    const passportCheck = l2.slice(9,10);
    const nationality = l2.slice(10,13);
    const birth = l2.slice(13,19);
    const birthCheck = l2.slice(19,20);
    const sex = l2.slice(20,21);
    const expiry = l2.slice(21,27);
    const expiryCheck = l2.slice(27,28);
    const personalNumber = l2.slice(28,42).replace(/<+$/,'');
    const personalCheck = l2.slice(42,43);

    return {
      docType, issuing,
      surname: surname ? surname.replace(/</g,' ').trim() : '',
      givenNames: given ? given.replace(/</g,' ').trim() : '',
      passportNumber, passportCheck,
      nationality, birth, birthCheck,
      sex, expiry, expiryCheck, personalNumber, personalCheck
    };
  }
</script></body>
</html>